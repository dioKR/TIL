# 모델링과 마이그레이션

### 모델 내부 Meta 클래스의 다양한 옵션

```python
from django.db import models

class Workout(models.Model):
  name = models.CharField(max_length=128, help_text="운동명")

  created_at = models.DateTimeField(auto_now_add=True, help_text="생성 날짜")
  updated_at = models.DateTimeField(auto_now=True, help_text="수정 날짜")

  class Meta:
    abstarct = False
    managed = True
    proxy = False

    db_table = "workout"
    get_latest_by = ("created_at", "name")
    ordering = ("-modified_at", "name")

    indexes = (
      models.Index(fields=("modified_at"), name="workout_modified_at_idx")
    )
```

- abstarct
  - 기본값 : False
  - True일 경우 추상 모델 취급
  - 추상 모델로 취급 --> 마이그레이션 수행할 때 제외 --> 테이블로 반영 X
- managed
  - 기본값 : False
  - manaded = False --> DB 마이그레이션에서 제외
  - 해당 모델을 장고가 관리하지 않는다.
  - 이미 생성된 테이블에 매핑하고 싶거나 장고가 특정 테이블을 수정하는 것을 방지하고자 할때 사용
  - 반드시 장고의 모델과 테이블이 1:1 매핑이 되는 것은 아니다.
- proxy
  - 기본값 : False
  - 하나의 테이블을 2개 이상의 모델로 나눠서 표현하고 싶을 떄 사용
- db_table
  - 기본값 : f"{app*label}*{model_name}"
  - 장고가 지어주는 테이블명은 좋지 않으니 db_table 명을 항상 선언 해줄 것을 권장
- db_table_comment
  - 데이터베이스의 테이블을 설명하는 주석을 달고 싶을때 사용
  - 모델뿐만 아니라 필드에도 db_comment라는 인자로 주석을 달수 있다.
  - help_text는 장고 모델에서만 볼수있다.
  - db_table_comment, db_comment는 데이터베이스 테이블에서 볼 수 있다.
  - 팀 내 DBA, 데이터 분석가가 있다면 help_text 대신 사용하자
- get_latest_by
  - 기본값 : pk
  - 장고 쿼리셋의 latest() 호출 시 사용된다.
  - 가장 최근 값의 기준을 어떤 필드로 사용할 것인지를 명시하는 옵션
- ordering
  - 기본값 : None
  - 장고 ORM으로 데이터 조회 시 정렬 방법을 설정할 때 사용
  - None일 경우 기본 정렬 값인 pk 오름차순으로 정렬하여 데이터 조회
- indexes
  - 기본값 : []
  - 장고 3.0 부터 추가된 옵션
  - 기존 방식인 Field(index=True) 옵션 대체할 수 있고 더 상세하고 다양하게 표현 가능
  - indexes는 데이터베이스에 DDL로 생성되어 반영되는 옵션
  - 인덱스 이름을 정확하게 지정하고 싶거나 복합 인덱스를 선언해야한다면 사용
  - 그러나 그렇지 않더라도 indexes 옵션을 사용해서 생성할 것을 추천
    - 1. 인덱스는 데이터 베이스 기능이기 때문에 Field라는 객체가 인덱스 정보를 가지고 있다면 의미가 어색해진다.
    - 2. 인덱스에 대한 정보가 한 곳에 모이지 않으면 협업하는 다른 개발자가 인덱스 관련 정보를 놓칠 수도 있다.
- constraints
  - 기본값 : []
  - 데이터베이스 수준에서 어떠한 조건을 제한하는 옵션
  - 이 또한 DDL로 생성되어 반영
  - Field에 표현 가능하지만 이 역시 해당 옵션을 사용하는 것을 추천

### 필드

- AutoField
- BigAutoField
  - 1 to 92233720368454775807
  - 장고 3.2 이후 버전부터는 AutoField 보다 BugAutoField 사용 권장
  - 장고 5.x부터는 기본 설정값이 BigAutoField로 선언될 예정
- CharField
- TextField
- TextChoices
  - enum 대체
- IntegerField
- FloatField
- DecimalField
  - 소수점 자릿수와 정수 크기가 제한되어 있다면 해당 필드 사용
  - 무한 소수 발생 이슈 방지
    - ex) 0.045 - 0.01 = 0.34999999...
- IntegerChoices
  - Integer 타입 Enum
  - 변수명 = 실제 db에 들어가는 int 값, "라벨 값(사람이 읽기 편한 값)"
- DateTimeField
- DateField
- TimeField
- DurationField
- FileSystemStorage
  - 기본 파일 스토리지로 로컬 파일 시스템을 사용하여 파일 저장
- S3BotoStorage
  - AWS S3
- GoogleCloudStorage
  - 구글 클라우드
- FileField
- ImageField
  - 파이썬 이미지 라이브러리 Pillow 설치 필요
- PostGIS
  - 좌표와 지도상 공간

### 모델 간 매핑 필드

- ForeignKey (1:N 관계 매핑)
  - N에 해당하는 클래스 내부에 생성
  - to 옵션 : 1에 해당하는 쪽에 옵션 주기
  - to 옵션 부여시 객체 매핑보단 문자열로 모델 클래스명 매핑 -> 순환 참조 에러 방지
- OneToOne (1:1 관계 매핑)
  - OneToOneField 사용
  - 데이터베이스 관점에서 unique=True라는 고정 옵션을 가진 ForeignKey와 같다.
  - but OneToOneField는 개발자의 설계의도를 좀 더 명확하게 해주고 더 간결한 코드를 작성할 수 있게해준다.
- ManyToMany (M:N 관계 매핑)
- ManyToManyField 사용
- 반드시 through = 옵션을 선언할 것을 권장

### 커스텀 필드

- 암복호화 필드(Encrypted Field)

## 마이그레이션

- 장고에서 모델링을 하면 DDL로 해당 모델 기반의 플랜을 작성해준다.

### makemigrations

- DDL을 자문 받는 명령어
- migrations 폴더의 하위 파일들과 modles.py와의 차이를 비교
- 차이가 있다면 일치시키기 위해 새로운 마이그레이션 파일 생성
- \*장고가 제안해주는 정보일 뿐 완벽하지 않을 수도 있다.
- 장고는 변경하는것이 아닌 삭제, 생성 방식

### Operations

- 장고 마이그레이션 모듈이 가지고 있는 명령어
- 마이그레이션 파일 안에서 사용하는 형태
- CreateModel, DeleteModel, AlterModelTable ...
- AddField, RemoveField, AlterField ...

### sqlmigrate

- 마이그레이션 수행 계획 검토 명령어
- 시스템에 영향을 주지 않는다.
- 각 마이그레이션 파일이 수행될 때 발생하는 DDL을 출력해서 보여준다.

```bash
python manage.py sqlmigrate {장고 앱 이름} {마이그레이션 파일 번호}
```

### migrate

- 실제 데이터베이스에 마이그레이션을 반영하는 명령어'
- 파일 단위 수행 가능

```bash
python manage.py migrate # 파일 전체 수행
python manage.py migrate {장고 앱 이름} {마이그레이션 파일 번호} # 파일 단위 수행
```

- --fake 옵션, --plan 옵션

### shomigrations

- 마이그레이션 이력 조회

### squashmigrations

- 마이그레이션 이력 통합하기
- 여러 개의 마이그레이션 파일을 1개의 마이그레이션 파일로 합쳐주는 명령어

```bash
python manage.py squashmigrations {장고 앱 이름} {마이그레이션 파일 번호1} {마이그레이션 파일 번호2}

python manage.py squashmigrations --squashed-name {원하는 파일이름} {장고 앱 이름} {마이그레이션 파일 번호1} {마이그레이션 파일 번호2}
```

### makemigrations --empty

- 비어 있는 마이그레이션 파일 생성
- 커스텀 마이그레이션 파일 생성, 주로 데이터 마이그레이션에 사용
