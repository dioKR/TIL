# ORM과 쿼리셋

### ORM

- ORM은 객체 지향형과 관계 지향형 패러다임 간 차이로 복잡해질 수 있는 로직을 객체지향 적인 코드로 작성할 수 있도록 보조해준다. 이렇게 ORM으로 만들어진 로직은 더 직관적이며 개발자가 비즈니스 로직에만 집중할 수 있도록 도와준다.

- 장고 모델에는 objects라는 변수명을 가진 객체가 기본 내장
- ORM 개념을 구현하기 위한 모듈로 쿼리셋과 매니저가 존재
- objects에는 장고의 매니저 모듈이 들어가 있다.

```python
from django.db import models
from jdnago.db.models import Manager


class User(models.Model):
  name = models.CharField(max_length=150,)

  # objects = ModelManger()
```

### 쿼리셋

- 쿼리셋은 모델로 데이터베이스의 데이터를 제어할 수 있도록 해주는 객체

```python
User.objects.filter(username="abcd") # 리턴값이 QuerySet 객체


user_list = User.objects.all() # user_list라는 변수에는 List[User] 라는 데이터 X

user_queryset : QuerySet[User] = User.objects.all() # QuerySet 객체

# 실제 user 목록을 가져오는 시점은 QuerySet을 수행하는 시점
user_list : List[User] = list(user_queryset)
```

### 쿼리셋의 특징

- 쿼리셋은 정말 필요한 시점에 SQL 질의를 한다.
  - 쿼리셋 객체가 Return되는 시점은 SQL 질의 시점이 아니다.
- 쿼리셋은 정말 필요한 만큼만 SQL 질의를 한다.
  - 특정 함수를 호출하거나 인덱스에 접근하거나 list로 감쌀때 SQL 질의를 한다.
- 쿼리셋은 SQL의 발생을 최대한 지연시킨다.
  - 새로운 조건절을 추가해도 SQL 질의하지 않는다.
- 쿼리셋은 캐싱된 데이터를 재사용해서 SQL 호춣을 줄인다.

- LazyLoading 지연로딩
- Caching 캐싱
- EagerLoading 즉시로딩

### get()와 filter()의 차이 그리고 first()

- get()
  - 즉시 SQL로 데이터를 질의
  - 하나의 데이터만 반환 받을 수 있기 때문에 2개 이상 존재시 MultipleObjectsReturned 예외 발생
  - 반환받을 데이터가 반드시 1개라고 보장할 수 없다면 예외처리 필요
  - 상황에 따라 적절한 예외 처리 필요
  - get()은 MultipleObjectsReturned와 DoesNotExist예외를 발생시킬수 있기 떄문

```python

user = None

try:
  user = User.objects.get(first_name="yeji")
except MultipleObjectsReturned as e:
  user = None
except User.DoesNotExist as e:
  user = None
```

- filter()

  - 즉시 질의하지 않는다.
  - 반환되는 값은 데이터가 아닌 쿼리셋이다.

- first()
  - 예외처리를 하지않고 간결하게 작성하고 싶을때 사용
  - objects.filter().first()
  - 단 무조건 에러를 내지 않는 로직이 항상 좋은 것은 아니다. 필요할 때는 에러를 발생시켜 로직의 문제를 빨리 파악하는게 더 좋을 수도 있다.
